<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MQTT AAA Device Control</title>
  <!-- Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>
  <script>
    // Conexión al broker MQTT con el path '/mqtt'
    const client = mqtt.connect('ws://broker.emqx.io:8083/mqtt');

    // Listener global para los mensajes MQTT
    client.on('message', function (topic, message) {
      // Mostrar en consola el mensaje recibido
      console.log(`Mensaje recibido -> Tópico: ${topic} | Mensaje: ${message.toString()}`);
      
      // Mostrar el mensaje en el elemento de visualización
      const messageDisplay = document.getElementById('messageDisplay');
      const newMessage = document.createElement('li');
      newMessage.classList.add('list-group-item');
      newMessage.innerText = `Tópico: ${topic} | Mensaje: ${message.toString()}`;
      messageDisplay.appendChild(newMessage);
    });

    // Una vez conectado, suscribirse a los tópicos de todos los dispositivos
    client.on('connect', function () {
      console.log('Conectado al broker MQTT');
      subscribeAllDevices();
    });

    // Función para obtener todos los dispositivos
    function fetchDevices() {
      fetch('/devices')
        .then(response => response.json())
        .then(data => {
          const deviceList = document.getElementById('deviceList');
          deviceList.innerHTML = '';
          data.forEach(device => {
            const deviceItem = document.createElement('li');
            deviceItem.classList.add('list-group-item');
            deviceItem.innerHTML = `
              <strong>${device.name}</strong><br>
              Topic: ${device.topic} | Status: ${device.status}
              <button class="btn btn-success btn-sm ml-3" onclick="turnOnDevice(${device.id})">Turn On</button>
              <button class="btn btn-danger btn-sm ml-3" onclick="turnOffDevice(${device.id})">Turn Off</button>
              <button class="btn btn-warning btn-sm ml-3" onclick="deleteDevice(${device.id})">Delete</button>
            `;
            deviceList.appendChild(deviceItem);
          });
        })
        .catch(error => alert('Error fetching devices: ' + error));
    }

    // Función para suscribirse a los tópicos de todos los dispositivos
    function subscribeAllDevices() {
      fetch('/devices')
        .then(response => response.json())
        .then(devices => {
          devices.forEach(device => {
            client.subscribe(device.topic, function (err) {
              if (err) {
                console.error('Error suscribiéndose al tópico ' + device.topic + ':', err);
              } else {
                console.log('Suscrito al tópico: ' + device.topic);
              }
            });
          });
        })
        .catch(error => alert('Error suscribiéndose a los tópicos: ' + error));
    }

    // Función para agregar un dispositivo
    function addDevice() {
      const name = document.getElementById('deviceName').value;
      const topic = document.getElementById('deviceTopic').value;

      fetch('/devices', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name, topic: topic })
      })
        .then(response => response.json())
        .then(data => {
          alert(data.message || data.error);
          if (data.message) {
            fetchDevices();
            // Suscribirse al nuevo tópico
            client.subscribe(topic, function (err) {
              if (!err) {
                console.log('Suscrito al nuevo tópico: ' + topic);
              }
            });
          }
        })
        .catch(error => alert('Error adding device: ' + error));
    }

    // Función para actualizar un dispositivo
    function updateDevice() {
      const deviceId = document.getElementById('updateDeviceId').value;
      const name = document.getElementById('updateDeviceName').value;
      const status = document.getElementById('updateDeviceStatus').value;

      fetch(`/devices/${deviceId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name, status: status })
      })
        .then(response => response.json())
        .then(data => {
          alert(data.message || data.error);
          if (data.message) fetchDevices();
        })
        .catch(error => alert('Error updating device: ' + error));
    }

    // Función para eliminar un dispositivo
    function deleteDevice(deviceId) {
      fetch(`/devices/${deviceId}`, {
        method: 'DELETE'
      })
        .then(response => response.json())
        .then(data => {
          alert(data.message || data.error);
          if (data.message) fetchDevices();
        })
        .catch(error => alert('Error deleting device: ' + error));
    }

    // Función para encender un dispositivo
    function turnOnDevice(deviceId) {
      fetch(`/devices/${deviceId}/turn_on`, { method: 'POST' })
        .then(response => response.json())
        .then(data => alert(data.message || data.error))
        .catch(error => alert('Error turning on device: ' + error));
    }

    // Función para apagar un dispositivo
    function turnOffDevice(deviceId) {
      fetch(`/devices/${deviceId}/turn_off`, { method: 'POST' })
        .then(response => response.json())
        .then(data => alert(data.message || data.error))
        .catch(error => alert('Error turning off device: ' + error));
    }

    // Inicializar la página: cargar dispositivos
    window.onload = function() {
      fetchDevices();
    };
  </script>
</head>
<body>
  <div class="container mt-5">
    <h1 class="text-center">MQTT Device Control</h1>

    <!-- Formulario para agregar un dispositivo -->
    <div class="card mb-4">
      <div class="card-body">
        <h4 class="card-title">Agregar Dispositivo</h4>
        <input type="text" id="deviceName" class="form-control mb-2" placeholder="Nombre del dispositivo">
        <input type="text" id="deviceTopic" class="form-control mb-2" placeholder="Tópico del dispositivo">
        <button class="btn btn-primary" onclick="addDevice()">Agregar</button>
      </div>
    </div>

    <!-- Formulario para actualizar un dispositivo -->
    <div class="card mb-4">
      <div class="card-body">
        <h4 class="card-title">Actualizar Dispositivo</h4>
        <input type="number" id="updateDeviceId" class="form-control mb-2" placeholder="ID del dispositivo">
        <input type="text" id="updateDeviceName" class="form-control mb-2" placeholder="Nuevo nombre del dispositivo">
        <input type="text" id="updateDeviceStatus" class="form-control mb-2" placeholder="Nuevo estado del dispositivo">
        <button class="btn btn-warning" onclick="updateDevice()">Actualizar</button>
      </div>
    </div>

    <!-- Lista de dispositivos -->
    <h3>Dispositivos</h3>
    <ul id="deviceList" class="list-group">
      <!-- Los dispositivos se agregarán aquí dinámicamente -->
    </ul>

    <!-- Visualización de mensajes MQTT -->
    <h3 class="mt-5">Mensajes MQTT</h3>
    <ul id="messageDisplay" class="list-group">
      <!-- Los mensajes MQTT se agregarán aquí dinámicamente -->
    </ul>
  </div>

  <!-- Bootstrap JS y dependencias -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
